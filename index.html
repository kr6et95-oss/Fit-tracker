<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ì²´ì¤‘ ê´€ë¦¬ëŠ” ê¾¸ì¤€í•¨ì´ ë‹µì…ë‹ˆë‹¤">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FIT TRACKER">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23667eea' width='100' height='100'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3EğŸ’ª%3C/text%3E%3C/svg%3E">
    <title>FIT TRACKER - ì²´ì¤‘ ê´€ë¦¬</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #1a1a2e;
            --accent: #ff6b6b;
            --success: #4ecdc4;
            --warning: #ffe66d;
            --bg: #f8f9fa;
            --card: #ffffff;
        }
        
        body {
            font-family: 'Nanum Gothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            font-family: 'Poppins', sans-serif;
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Nanum Gothic', sans-serif;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        textarea { resize: vertical; min-height: 80px; }
        
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255,107,107,0.4);
        }
        
        .btn-secondary {
            background: var(--success);
            color: white;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
        }
        
        .water-btn {
            padding: 10px 15px;
            background: #e3f2fd;
            color: #1565c0;
            border: 2px solid #90caf9;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .water-btn:hover {
            background: #90caf9;
            color: white;
            transform: translateY(-2px);
        }
        
        .header-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.95);
            color: var(--primary);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .meal-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .meal-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .meal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .meal-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .meal-name {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .meal-count {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .progress-section {
            margin: 20px 0;
        }

        .progress-item {
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .progress-label {
            font-size: 1rem;
            color: var(--primary);
        }

        .progress-values {
            font-size: 0.9rem;
            color: #666;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .progress-bar.protein {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .progress-bar.carb {
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
        }

        .progress-bar.fat {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        }

        .progress-bar.over {
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .remaining-text {
            margin-top: 5px;
            font-size: 0.85rem;
            color: #666;
        }

        .remaining-text.complete {
            color: var(--success);
            font-weight: 700;
        }

        .remaining-text.over {
            color: #ff6b6b;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .goal-box {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .goal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .goal-item {
            text-align: center;
        }
        
        .goal-label {
            font-size: 0.9rem;
            color: #333;
            margin-bottom: 5px;
        }
        
        .goal-value {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 40px auto;
            padding: 0;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
        }
        
        .close {
            font-size: 2rem;
            cursor: pointer;
            color: white;
            background: none;
            border: none;
        }
        
        .modal-body {
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .method-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .method-btn {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .method-btn:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
        }
        
        .method-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .food-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .food-item {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .food-item:hover {
            border-color: var(--accent);
            background: #fff5f5;
        }
        
        .food-item.selected {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
        }
        
        .food-item-photo {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .food-item-content {
            flex: 1;
        }
        
        .food-name {
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .food-info {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .added-list {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .added-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .photo-upload {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border: 2px dashed #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            margin: 20px 0;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .photo-item {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }
        
        .history-date {
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 0.95rem;
        }
        
        .hidden { display: none !important; }
        
        @media (max-width: 600px) {
            h1 { font-size: 2rem; }
            .meal-grid, .stats-grid, .goal-grid, .method-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ’ª FIT TRACKER</h1>
            <p class="subtitle">ì²´ì¤‘ ê´€ë¦¬ëŠ” ê¾¸ì¤€í•¨ì´ ë‹µì…ë‹ˆë‹¤</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                <button onclick="toggleDarkMode()" class="header-btn" id="darkModeBtn">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
                <button onclick="openWaterModal()" class="header-btn">ğŸ’§ ë¬¼</button>
                <button onclick="openFavoritesModal()" class="header-btn">â­ ì¦ê²¨ì°¾ê¸°</button>
                <button onclick="openRecentModal()" class="header-btn">ğŸ• ìµœê·¼</button>
                <button onclick="openTemplateModal()" class="header-btn">ğŸ“‹ í…œí”Œë¦¿</button>
                <button onclick="openNutritionChartModal()" class="header-btn">ğŸ“Š ì°¨íŠ¸</button>
                <button onclick="openNotificationModal()" class="header-btn">ğŸ”” ì•Œë¦¼</button>
                <button onclick="openBackupModal()" class="header-btn">ğŸ’¾ ë°±ì—…</button>
            </div>
        </header>

        <!-- ì„¤ì • -->
        <div id="settingsCard" class="card hidden">
            <h2>âš™ï¸ ê¸°ë³¸ ì„¤ì •</h2>
            <div class="input-group">
                <label>ì„±ë³„</label>
                <select id="gender">
                    <option value="male">ë‚¨ì„±</option>
                    <option value="female">ì—¬ì„±</option>
                </select>
            </div>
            <div class="input-group">
                <label>ë‚˜ì´</label>
                <input type="number" id="age" placeholder="25">
            </div>
            <div class="input-group">
                <label>í‚¤ (cm)</label>
                <input type="number" id="height" placeholder="175">
            </div>
            <div class="input-group">
                <label>í˜„ì¬ ì²´ì¤‘ (kg)</label>
                <input type="number" id="currentWeight" step="0.1" placeholder="70">
            </div>
            <div class="input-group">
                <label>ì²´ì§€ë°©ë¥  (%)</label>
                <input type="number" id="bodyFat" step="0.1" placeholder="20">
            </div>
            <div class="input-group">
                <label>ëª©í‘œ ì²´ì¤‘ (kg)</label>
                <input type="number" id="targetWeight" step="0.1" placeholder="65">
            </div>
            <div class="input-group">
                <label>í™œë™ ìˆ˜ì¤€</label>
                <select id="activityLevel">
                    <option value="1.2">ê±°ì˜ ì•ˆ ì›€ì§ì„ - ì‚¬ë¬´ì§, í•˜ë£¨ ì¢…ì¼ ì•‰ì•„ì„œ ì¼í•¨</option>
                    <option value="1.375">ê°€ë²¼ìš´ í™œë™ - ê°€ë” ê±·ê¸°, ì£¼ 1-2íšŒ ê°€ë²¼ìš´ ìš´ë™</option>
                    <option value="1.55" selected>ë³´í†µ í™œë™ - ì£¼ 3-4íšŒ ìš´ë™, ì§ì¥ì—ì„œ ìì£¼ ì´ë™</option>
                    <option value="1.725">í™œë°œí•œ í™œë™ - ì£¼ 5-6íšŒ ìš´ë™, ìœ¡ì²´ ë…¸ë™</option>
                    <option value="1.9">ë§¤ìš° í™œë°œ - ë§¤ì¼ ê³ ê°•ë„ ìš´ë™, ìš´ë™ì„ ìˆ˜ ìˆ˜ì¤€</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">ì„¤ì • ì €ì¥</button>
        </div>

        <!-- ëª©í‘œ -->
        <div id="goalCard" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ğŸ“Š ë‚˜ì˜ ëª©í‘œ</h2>
                <button class="btn btn-small btn-secondary" onclick="showSettings()">ìˆ˜ì •</button>
            </div>
            <div class="goal-box">
                <div class="goal-grid">
                    <div class="goal-item">
                        <div class="goal-label">í˜„ì¬</div>
                        <div class="goal-value" id="dispCurrent">-</div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-label">ëª©í‘œ</div>
                        <div class="goal-value" id="dispTarget">-</div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-label">ê°ëŸ‰</div>
                        <div class="goal-value" id="dispDiff">-</div>
                    </div>
                </div>
                <div style="text-align: center; padding-top: 15px; border-top: 2px solid rgba(0,0,0,0.1);">
                    <div class="goal-label">ì˜ˆìƒ ê¸°ê°„</div>
                    <div class="goal-value" id="dispDays" style="font-size: 1.8rem;">-</div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <div class="stat-label">ì¹¼ë¡œë¦¬</div>
                    <div class="stat-value" id="dispCal">-</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                    <div class="stat-label">ë‹¨ë°±ì§ˆ</div>
                    <div class="stat-value" id="dispPro">-</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                    <div class="stat-label">íƒ„ìˆ˜í™”ë¬¼</div>
                    <div class="stat-value" id="dispCarb">-</div>
                </div>
            </div>
        </div>

        <!-- ì¼ì¼ ê¸°ë¡ -->
        <div id="recordCard" class="card hidden">
            <h2>ğŸ“… ì˜¤ëŠ˜ ê¸°ë¡</h2>
            <div class="input-group">
                <label>ì²´ì¤‘ (kg)</label>
                <input type="number" id="todayWeight" step="0.1" placeholder="70.5">
            </div>

            <div class="input-group">
                <label>ì²´ì§€ë°©ë¥  (%)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="todayBodyFat" step="0.1" placeholder="20" style="flex: 1;">
                    <label style="display: flex; align-items: center; gap: 5px; margin: 0; white-space: nowrap;">
                        <input type="checkbox" id="bodyFatUnknown" onchange="toggleBodyFat()" style="width: auto;">
                        <span>ëª¨ë¦„</span>
                    </label>
                </div>
            </div>
            
            <label>ì‹ì‚¬ ê¸°ë¡</label>
            <div class="meal-grid">
                <div class="meal-card" onclick="openMeal('breakfast')">
                    <div class="meal-icon">ğŸ³</div>
                    <div class="meal-name">ì•„ì¹¨</div>
                    <div class="meal-count" id="breakfastCount">(0)</div>
                </div>
                <div class="meal-card" onclick="openMeal('lunch')">
                    <div class="meal-icon">ğŸ±</div>
                    <div class="meal-name">ì ì‹¬</div>
                    <div class="meal-count" id="lunchCount">(0)</div>
                </div>
                <div class="meal-card" onclick="openMeal('dinner')">
                    <div class="meal-icon">ğŸ½ï¸</div>
                    <div class="meal-name">ì €ë…</div>
                    <div class="meal-count" id="dinnerCount">(0)</div>
                </div>
                <div class="meal-card" onclick="openMeal('snack')">
                    <div class="meal-icon">ğŸª</div>
                    <div class="meal-name">ê°„ì‹</div>
                    <div class="meal-count" id="snackCount">(0)</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
                <button class="btn btn-secondary" onclick="quickPhotoUpload('breakfast')" style="padding: 12px; font-size: 0.95rem;">ğŸ“¸ ì•„ì¹¨ ì‚¬ì§„</button>
                <button class="btn btn-secondary" onclick="quickPhotoUpload('lunch')" style="padding: 12px; font-size: 0.95rem;">ğŸ“¸ ì ì‹¬ ì‚¬ì§„</button>
                <button class="btn btn-secondary" onclick="quickPhotoUpload('dinner')" style="padding: 12px; font-size: 0.95rem;">ğŸ“¸ ì €ë… ì‚¬ì§„</button>
                <button class="btn btn-secondary" onclick="quickPhotoUpload('snack')" style="padding: 12px; font-size: 0.95rem;">ğŸ“¸ ê°„ì‹ ì‚¬ì§„</button>
            </div>

            <div id="photoSection" class="hidden" style="margin-top: 20px;">
                <label>ì‹ì‚¬ ì‚¬ì§„</label>
                <div class="photo-grid" id="photoGrid"></div>
            </div>

            <div class="progress-section">
                <h3 style="color: var(--primary); margin-bottom: 15px;">ğŸ¯ ì˜¤ëŠ˜ì˜ ì˜ì–‘ì†Œ ëª©í‘œ</h3>
                
                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">ë‹¨ë°±ì§ˆ</span>
                        <span class="progress-values"><span id="currentPro">0</span>g / <span id="goalPro">0</span>g</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar protein" id="barPro" style="width: 0%;">
                            <span id="percentPro">0%</span>
                        </div>
                    </div>
                    <div class="remaining-text" id="remainPro">-</div>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">íƒ„ìˆ˜í™”ë¬¼</span>
                        <span class="progress-values"><span id="currentCarb">0</span>g / <span id="goalCarb">0</span>g</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar carb" id="barCarb" style="width: 0%;">
                            <span id="percentCarb">0%</span>
                        </div>
                    </div>
                    <div class="remaining-text" id="remainCarb">-</div>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">ì§€ë°©</span>
                        <span class="progress-values"><span id="currentFat">0</span>g / <span id="goalFat">0</span>g</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar fat" id="barFat" style="width: 0%;">
                            <span id="percentFat">0%</span>
                        </div>
                    </div>
                    <div class="remaining-text" id="remainFat">-</div>
                </div>

                <div class="progress-item">
                    <div class="progress-header">
                        <span class="progress-label">ì´ ì¹¼ë¡œë¦¬</span>
                        <span class="progress-values"><span id="currentCal2">0</span> / <span id="goalCal2">0</span> kcal</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar protein" id="barCal" style="width: 0%;">
                            <span id="percentCal">0%</span>
                        </div>
                    </div>
                    <div class="remaining-text" id="remainCal">-</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">ì´ ì¹¼ë¡œë¦¬</div>
                    <div class="stat-value" id="totalCal">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ë‹¨ë°±ì§ˆ</div>
                    <div class="stat-value" id="totalPro">0g</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">íƒ„ìˆ˜í™”ë¬¼</div>
                    <div class="stat-value" id="totalCarb">0g</div>
                </div>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <label>ğŸ’§ ë¬¼ ì„­ì·¨ëŸ‰</label>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                    <input type="number" id="waterIntake" step="100" placeholder="0" value="0" style="flex: 1;" readonly>
                    <span style="white-space: nowrap; font-weight: 700;">ml</span>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button onclick="addWater(100)" class="btn-clear" style="flex: 1; min-width: 70px;">+100ml</button>
                    <button onclick="addWater(200)" class="btn-clear" style="flex: 1; min-width: 70px;">+200ml</button>
                    <button onclick="addWater(300)" class="btn-clear" style="flex: 1; min-width: 70px;">+300ml</button>
                    <button onclick="addWater(500)" class="btn-clear" style="flex: 1; min-width: 70px;">+500ml</button>
                    <button onclick="resetWater()" class="btn-clear" style="background: #ffebee; color: #c62828;">ì´ˆê¸°í™”</button>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 8px; text-align: center; font-size: 0.9rem; color: #1565c0;">
                    ğŸ’¡ ê¶Œì¥: í•˜ë£¨ 2000ml (8ì”)
                </div>
            </div>

            <div class="input-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="exercise" style="width: auto;">
                    <span>ì˜¤ëŠ˜ ìš´ë™í–ˆì–´ìš”! ğŸ’ª</span>
                </label>
            </div>

            <div class="input-group">
                <label>ë©”ëª¨</label>
                <textarea id="memo" placeholder="ì˜¤ëŠ˜ì˜ ê¸°ë¡..."></textarea>
            </div>

            <button class="btn btn-primary" onclick="saveRecord()">ê¸°ë¡ ì €ì¥</button>
        </div>

        <!-- íˆìŠ¤í† ë¦¬ -->
        <div id="historyCard" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ğŸ“Š ê¸°ë¡ íˆìŠ¤í† ë¦¬</h2>
                <button class="btn btn-small btn-secondary" onclick="clearAll()">ì „ì²´ ì‚­ì œ</button>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-small" id="tabDaily" onclick="showTab('daily')" style="flex: 1; background: var(--accent); color: white;">ì¼ë³„ ê¸°ë¡</button>
                <button class="btn btn-small" id="tabWeekly" onclick="showTab('weekly')" style="flex: 1; background: #e0e0e0;">ì£¼ê°„ í†µê³„</button>
                <button class="btn btn-small" id="tabMonthly" onclick="showTab('monthly')" style="flex: 1; background: #e0e0e0;">ì›”ê°„ í†µê³„</button>
            </div>

            <div id="dailyTab">
                <div id="historyList"></div>
            </div>

            <div id="weeklyTab" class="hidden">
                <canvas id="weeklyChart" style="max-height: 300px; margin-bottom: 20px;"></canvas>
                <div id="weeklyStats"></div>
            </div>

            <div id="monthlyTab" class="hidden">
                <canvas id="monthlyChart" style="max-height: 300px; margin-bottom: 20px;"></canvas>
                <div id="monthlyStats"></div>
            </div>
        </div>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div id="mealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ì‹ì‚¬ ì¶”ê°€</h3>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="methodSelect">
                    <div class="method-grid">
                        <div class="method-btn" onclick="selectMethod('db')">
                            <div class="method-icon">ğŸ“‹</div>
                            <div>ìŒì‹ ì„ íƒ</div>
                        </div>
                        <div class="method-btn" onclick="selectMethod('manual')">
                            <div class="method-icon">âœï¸</div>
                            <div>ì§ì ‘ ì…ë ¥</div>
                        </div>
                    </div>
                </div>

                <div id="dbSection" class="hidden">
                    <button class="btn btn-small btn-secondary" onclick="backToMethod()" style="margin-bottom: 15px;">â† ëŒì•„ê°€ê¸°</button>
                    <div class="input-group">
                        <input type="text" id="foodSearch" placeholder="ìŒì‹ ê²€ìƒ‰..." oninput="searchFood()">
                    </div>
                    <div class="food-list" id="foodList"></div>
                    <div id="amountSection" class="hidden" style="margin-top: 15px;">
                        <div class="input-group">
                            <label>ì–‘ (g)</label>
                            <input type="number" id="foodAmount" placeholder="100">
                        </div>
                        <button class="btn btn-primary" onclick="addFood()">ì¶”ê°€</button>
                    </div>
                </div>

                <div id="manualSection" class="hidden">
                    <button class="btn btn-small btn-secondary" onclick="backToMethod()" style="margin-bottom: 15px;">â† ëŒì•„ê°€ê¸°</button>
                    <div class="input-group">
                        <label>ìŒì‹ ì´ë¦„</label>
                        <input type="text" id="manualName" placeholder="ì¹˜í‚¨ ìƒëŸ¬ë“œ">
                    </div>
                    <div class="input-group">
                        <label>ìŒì‹ ì‚¬ì§„ (ì„ íƒ)</label>
                        <input type="file" id="manualPhoto" accept="image/*" onchange="previewManualPhoto()" style="padding: 8px;">
                        <div id="manualPhotoPreview" style="margin-top: 10px;"></div>
                    </div>
                    <div class="input-group">
                        <label>ì–‘ (g)</label>
                        <input type="number" id="manualAmount" placeholder="150">
                    </div>
                    <div class="input-group">
                        <label>ì¹¼ë¡œë¦¬ (kcal)</label>
                        <input type="number" id="manualCal" placeholder="200">
                    </div>
                    <div class="input-group">
                        <label>ë‹¨ë°±ì§ˆ (g)</label>
                        <input type="number" id="manualPro" step="0.1" placeholder="20">
                    </div>
                    <div class="input-group">
                        <label>íƒ„ìˆ˜í™”ë¬¼ (g)</label>
                        <input type="number" id="manualCarb" step="0.1" placeholder="10">
                    </div>
                    <div class="input-group">
                        <label>ì§€ë°© (g)</label>
                        <input type="number" id="manualFat" step="0.1" placeholder="8">
                    </div>
                    <div class="input-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="saveCustom" style="width: auto;">
                            <span>ë‚˜ë§Œì˜ ìŒì‹ì— ì €ì¥ (100g ê¸°ì¤€)</span>
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="addManual()">ì¶”ê°€</button>
                </div>

                <div id="addedSection" class="added-list hidden">
                    <h3 style="margin-bottom: 15px;">ì¶”ê°€ëœ ìŒì‹</h3>
                    <div id="addedList"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="addPhoto()">ğŸ“¸ ì‚¬ì§„</button>
                        <button class="btn btn-primary" onclick="saveMeal()">ì™„ë£Œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¬¼ ì„­ì·¨ëŸ‰ ëª¨ë‹¬ -->
    <div id="waterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ’§ ë¬¼ ì„­ì·¨ëŸ‰ ê¸°ë¡</h3>
                <button class="close" onclick="closeWaterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3rem; font-weight: 700; color: #1565c0;" id="waterDisplay">0ml</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">ê¶Œì¥: í•˜ë£¨ 2000ml</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                    <button onclick="addWater(100)" class="btn btn-secondary">+100ml</button>
                    <button onclick="addWater(200)" class="btn btn-secondary">+200ml</button>
                    <button onclick="addWater(300)" class="btn btn-secondary">+300ml</button>
                    <button onclick="addWater(500)" class="btn btn-secondary">+500ml</button>
                </div>
                <button onclick="resetWater()" class="btn" style="background: #ff6b6b; color: white; width: 100%;">ì´ˆê¸°í™”</button>
            </div>
        </div>
    </div>

    <!-- ì¦ê²¨ì°¾ê¸° ëª¨ë‹¬ -->
    <div id="favoritesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â­ ì¦ê²¨ì°¾ê¸° ìŒì‹</h3>
                <button class="close" onclick="closeFavoritesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="favoritesList"></div>
                <div id="noFavorites" class="hidden" style="text-align: center; padding: 40px; color: #999;">
                    ì¦ê²¨ì°¾ê¸°í•œ ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤<br>
                    <small>ìŒì‹ ì„ íƒ ì‹œ â­ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¦ê²¨ì°¾ê¸°í•˜ì„¸ìš”</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ë°±ì—… ëª¨ë‹¬ -->
    <div id="backupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ’¾ ë°ì´í„° ë°±ì—…/ë³µì›</h3>
                <button class="close" onclick="closeBackupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h4 style="margin-bottom: 15px;">ğŸ“¥ ë°ì´í„° ë°±ì—…</h4>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
                    ëª¨ë“  ê¸°ë¡ì„ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤
                </p>
                <button onclick="backupData()" class="btn btn-primary" style="width: 100%; margin-bottom: 30px;">
                    ğŸ’¾ ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                </button>

                <h4 style="margin-bottom: 15px;">ğŸ“¤ ë°ì´í„° ë³µì›</h4>
                <p style="margin-bottom: 15px; color: #666; font-size: 0.9rem;">
                    ë°±ì—… íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤
                </p>
                <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreData()">
                <button onclick="document.getElementById('restoreFile').click()" class="btn btn-secondary" style="width: 100%;">
                    ğŸ“‚ íŒŒì¼ ì„ íƒ
                </button>
            </div>
        </div>
    </div>

    <!-- ì‹ë‹¨ í…œí”Œë¦¿ ëª¨ë‹¬ -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“‹ ì‹ë‹¨ í…œí”Œë¦¿</h3>
                <button class="close" onclick="closeTemplateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="templateList"></div>
                <button onclick="saveCurrentAsTemplate()" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                    â• í˜„ì¬ ì‹ì‚¬ë¥¼ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥
                </button>
            </div>
        </div>
    </div>

    <!-- ìµœê·¼ ìŒì‹ ëª¨ë‹¬ -->
    <div id="recentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ• ìµœê·¼ ë¨¹ì€ ìŒì‹</h3>
                <button class="close" onclick="closeRecentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="recentList"></div>
            </div>
        </div>
    </div>

    <!-- ì˜ì–‘ì†Œ ì°¨íŠ¸ ëª¨ë‹¬ -->
    <div id="nutritionChartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“Š ì˜¤ëŠ˜ì˜ ì˜ì–‘ì†Œ ê· í˜•</h3>
                <button class="close" onclick="closeNutritionChartModal()">&times;</button>
            </div>
            <div class="modal-body">
                <canvas id="nutritionChart" style="max-height: 300px;"></canvas>
                <div id="nutritionDetails" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ ì„¤ì • ëª¨ë‹¬ -->
    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ”” ì•Œë¦¼ ì„¤ì •</h3>
                <button class="close" onclick="closeNotificationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 20px;">âš ï¸ ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</p>
                
                <div class="input-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="notifBreakfast" style="width: auto;">
                        <span>ì•„ì¹¨ ì‹ì‚¬ ì•Œë¦¼</span>
                    </label>
                    <input type="time" id="timeBreakfast" value="09:00" style="margin-top: 10px;">
                </div>

                <div class="input-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="notifLunch" style="width: auto;">
                        <span>ì ì‹¬ ì‹ì‚¬ ì•Œë¦¼</span>
                    </label>
                    <input type="time" id="timeLunch" value="13:00" style="margin-top: 10px;">
                </div>

                <div class="input-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="notifDinner" style="width: auto;">
                        <span>ì €ë… ì‹ì‚¬ ì•Œë¦¼</span>
                    </label>
                    <input type="time" id="timeDinner" value="19:00" style="margin-top: 10px;">
                </div>

                <div class="input-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="notifWater" style="width: auto;">
                        <span>ë¬¼ ì„­ì·¨ ì•Œë¦¼ (2ì‹œê°„ë§ˆë‹¤)</span>
                    </label>
                </div>

                <button onclick="saveNotificationSettings()" class="btn btn-primary" style="width: 100%;">
                    ì €ì¥
                </button>
            </div>
        </div>
    </div>

    <script>
        const foodDB = [
            {name:"ë°±ë¯¸ë°¥",cal:130,pro:2.5,carb:28,fat:0.3},
            {name:"í˜„ë¯¸ë°¥",cal:112,pro:2.6,carb:23.5,fat:0.9},
            {name:"ê³ êµ¬ë§ˆ",cal:86,pro:1,carb:20,fat:0.1},
            {name:"ê°ì",cal:77,pro:2,carb:17,fat:0.1},
            {name:"ì‹ë¹µ",cal:265,pro:8,carb:49,fat:3.5},
            {name:"ë‹­ê°€ìŠ´ì‚´",cal:165,pro:31,carb:0,fat:3.6},
            {name:"ê³„ë€",cal:155,pro:13,carb:1.1,fat:11},
            {name:"ì†Œê³ ê¸°",cal:140,pro:22,carb:0,fat:5.5},
            {name:"ë‘ë¶€",cal:76,pro:8,carb:1.9,fat:4.8},
            {name:"ìš°ìœ ",cal:61,pro:3.2,carb:4.8,fat:3.3},
            {name:"ë¸Œë¡œì½œë¦¬",cal:34,pro:2.8,carb:7,fat:0.4},
            {name:"ì‹œê¸ˆì¹˜",cal:23,pro:2.9,carb:3.6,fat:0.4},
            {name:"í† ë§ˆí† ",cal:18,pro:0.9,carb:3.9,fat:0.2},
            {name:"ë°”ë‚˜ë‚˜",cal:89,pro:1.1,carb:23,fat:0.3},
            {name:"ì‚¬ê³¼",cal:52,pro:0.3,carb:14,fat:0.2},
            {name:"ì•„ëª¬ë“œ",cal:579,pro:21,carb:22,fat:50},
        ];

        let currentMeal = '';
        let mealData = {breakfast:[],lunch:[],dinner:[],snack:[]};
        let photos = {breakfast:[],lunch:[],dinner:[],snack:[]};
        let customDB = JSON.parse(localStorage.getItem('customFoods')||'[]');
        let selected = null;
        let manualPhotoData = null;
        let dailyWater = 0;
        let favorites = JSON.parse(localStorage.getItem('favorites')||'[]');
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let templates = JSON.parse(localStorage.getItem('mealTemplates')||'[]');
        let recentFoods = JSON.parse(localStorage.getItem('recentFoods')||'[]');
        let nutritionChart = null;

        function quickPhotoUpload(mealType) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = e => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        photos[mealType].push(ev.target.result);
                        updatePhotos();
                        alert('ì‚¬ì§„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¸');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function previewManualPhoto() {
            const file = document.getElementById('manualPhoto').files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = e => {
                    manualPhotoData = e.target.result;
                    document.getElementById('manualPhotoPreview').innerHTML = 
                        `<img src="${manualPhotoData}" style="width: 100%; max-width: 200px; border-radius: 10px;">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleBodyFat() {
            const input = document.getElementById('todayBodyFat');
            const checkbox = document.getElementById('bodyFatUnknown');
            if(checkbox.checked) {
                input.disabled = true;
                input.value = '';
                input.style.background = '#f0f0f0';
            } else {
                input.disabled = false;
                input.style.background = '#FAFAFA';
            }
        }

        function init() {
            const settings = JSON.parse(localStorage.getItem('settings')||'null');
            if(settings) {
                document.getElementById('settingsCard').classList.add('hidden');
                document.getElementById('goalCard').classList.remove('hidden');
                document.getElementById('recordCard').classList.remove('hidden');
                document.getElementById('historyCard').classList.remove('hidden');
                showGoals(settings);
            } else {
                document.getElementById('settingsCard').classList.remove('hidden');
            }
            loadHistory();
            updateProgress();
            
            // ì„ì‹œ ë°ì´í„° ë¡œë“œ
            loadTempData();
            
            // ë‹¤í¬ëª¨ë“œ ì´ˆê¸°í™”
            if(isDarkMode) applyDarkMode();
            
            // ì¹˜íŒ…ë°ì´ ì²´í¬
            checkCheatDayAlert();
            
            // ì•Œë¦¼ ì„¤ì •
            setupNotifications();
        }

        function saveSettings() {
            const s = {
                gender: document.getElementById('gender').value,
                age: +document.getElementById('age').value,
                height: +document.getElementById('height').value,
                weight: +document.getElementById('currentWeight').value,
                fat: +document.getElementById('bodyFat').value,
                target: +document.getElementById('targetWeight').value,
                activity: +document.getElementById('activityLevel').value
            };
            if(!s.age||!s.height||!s.weight||!s.fat||!s.target) {
                alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            localStorage.setItem('settings',JSON.stringify(s));
            document.getElementById('settingsCard').classList.add('hidden');
            document.getElementById('goalCard').classList.remove('hidden');
            document.getElementById('recordCard').classList.remove('hidden');
            document.getElementById('historyCard').classList.remove('hidden');
            showGoals(s);
            alert('ì„¤ì • ì™„ë£Œ! ğŸ’ª');
        }

        function showSettings() {
            const s = JSON.parse(localStorage.getItem('settings'));
            document.getElementById('gender').value = s.gender;
            document.getElementById('age').value = s.age;
            document.getElementById('height').value = s.height;
            document.getElementById('currentWeight').value = s.weight;
            document.getElementById('bodyFat').value = s.fat;
            document.getElementById('targetWeight').value = s.target;
            document.getElementById('activityLevel').value = s.activity;
            document.getElementById('settingsCard').classList.remove('hidden');
            document.getElementById('goalCard').classList.add('hidden');
            document.getElementById('recordCard').classList.add('hidden');
        }

        function showGoals(s) {
            const bmr = s.gender==='male' ? (10*s.weight)+(6.25*s.height)-(5*s.age)+5 : (10*s.weight)+(6.25*s.height)-(5*s.age)-161;
            const tdee = bmr * s.activity;
            const cal = Math.round(tdee - 500);
            const lm = s.weight * (1 - s.fat/100);
            const pro = Math.round(lm * 2.2);
            const fat = Math.round((cal * 0.27)/9);
            const carb = Math.round((cal - pro*4 - fat*9)/4);
            const diff = s.weight - s.target;
            const days = Math.ceil(diff/0.5)*7;

            document.getElementById('dispCurrent').textContent = s.weight+'kg';
            document.getElementById('dispTarget').textContent = s.target+'kg';
            document.getElementById('dispDiff').textContent = diff.toFixed(1)+'kg';
            document.getElementById('dispDays').textContent = days+'ì¼';
            document.getElementById('dispCal').textContent = cal;
            document.getElementById('dispPro').textContent = pro+'g';
            document.getElementById('dispCarb').textContent = carb+'g';

            // ëª©í‘œê°’ ì €ì¥
            localStorage.setItem('goals', JSON.stringify({cal, pro, carb, fat}));
            updateProgress();
        }

        function updateProgress() {
            const goals = JSON.parse(localStorage.getItem('goals')||'{}');
            if(!goals.cal) return;

            let cal=0, pro=0, carb=0, fat=0;
            Object.values(mealData).forEach(m=>m.forEach(f=>{
                cal+=f.cal;
                pro+=f.pro;
                carb+=f.carb;
                fat+=f.fat;
            }));

            pro = Math.round(pro*10)/10;
            carb = Math.round(carb*10)/10;
            fat = Math.round(fat*10)/10;

            // ëª©í‘œê°’ í‘œì‹œ
            document.getElementById('goalPro').textContent = goals.pro;
            document.getElementById('goalCarb').textContent = goals.carb;
            document.getElementById('goalFat').textContent = goals.fat;
            document.getElementById('goalCal2').textContent = goals.cal;

            // í˜„ì¬ê°’ í‘œì‹œ
            document.getElementById('currentPro').textContent = pro;
            document.getElementById('currentCarb').textContent = carb;
            document.getElementById('currentFat').textContent = fat;
            document.getElementById('currentCal2').textContent = cal;

            // ì§„í–‰ë¥  ê³„ì‚°
            const proPer = Math.min((pro / goals.pro * 100), 100);
            const carbPer = Math.min((carb / goals.carb * 100), 100);
            const fatPer = Math.min((fat / goals.fat * 100), 100);
            const calPer = Math.min((cal / goals.cal * 100), 100);

            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
            updateBar('Pro', pro, goals.pro, proPer);
            updateBar('Carb', carb, goals.carb, carbPer);
            updateBar('Fat', fat, goals.fat, fatPer);
            updateBar('Cal', cal, goals.cal, calPer);
        }

        function updateBar(type, current, goal, percent) {
            const bar = document.getElementById('bar'+type);
            const percentSpan = document.getElementById('percent'+type);
            const remain = document.getElementById('remain'+type);
            
            bar.style.width = percent + '%';
            percentSpan.textContent = Math.round(percent) + '%';
            
            const diff = goal - current;
            const isOver = current > goal;
            const isComplete = percent >= 100;

            if(isOver) {
                bar.classList.add('over');
                remain.textContent = `âš ï¸ ${Math.abs(diff).toFixed(1)}${type==='Cal'?'kcal':'g'} ì´ˆê³¼`;
                remain.className = 'remaining-text over';
            } else if(isComplete) {
                remain.textContent = 'âœ… ëª©í‘œ ë‹¬ì„±!';
                remain.className = 'remaining-text complete';
            } else {
                bar.classList.remove('over');
                remain.textContent = `${diff.toFixed(1)}${type==='Cal'?'kcal':'g'} ë‚¨ìŒ`;
                remain.className = 'remaining-text';
            }
        }

        function openMeal(type) {
            currentMeal = type;
            const names = {breakfast:'ì•„ì¹¨',lunch:'ì ì‹¬',dinner:'ì €ë…',snack:'ê°„ì‹'};
            document.getElementById('modalTitle').textContent = names[type]+' ì¶”ê°€';
            document.getElementById('mealModal').style.display = 'block';
            backToMethod();
            updateAdded();
        }

        function closeModal() {
            document.getElementById('mealModal').style.display = 'none';
        }

        function selectMethod(m) {
            document.getElementById('methodSelect').classList.add('hidden');
            if(m==='db') {
                document.getElementById('dbSection').classList.remove('hidden');
                renderFoods();
            } else {
                document.getElementById('manualSection').classList.remove('hidden');
            }
        }

        function backToMethod() {
            document.getElementById('methodSelect').classList.remove('hidden');
            document.getElementById('dbSection').classList.add('hidden');
            document.getElementById('manualSection').classList.add('hidden');
            document.getElementById('amountSection').classList.add('hidden');
            selected = null;
        }

        function renderFoods(q='') {
            const all = [...foodDB,...customDB];
            const filtered = q ? all.filter(f=>f.name.includes(q)) : all;
            document.getElementById('foodList').innerHTML = filtered.map((f,i)=>`
                <div class="food-item" onclick="selectFood(${i})">
                    ${f.photo ? `<img src="${f.photo}" class="food-item-photo">` : ''}
                    <div class="food-item-content">
                        <div class="food-name">${f.name}</div>
                        <div class="food-info">${f.cal}kcal | P:${f.pro}g C:${f.carb}g F:${f.fat}g (100g)</div>
                    </div>
                </div>
            `).join('');
        }

        function searchFood() {
            renderFoods(document.getElementById('foodSearch').value);
        }

        function selectFood(i) {
            const all = [...foodDB,...customDB];
            selected = all[i];
            document.querySelectorAll('.food-item').forEach((el,idx)=>{
                el.classList.toggle('selected',idx===i);
            });
            document.getElementById('amountSection').classList.remove('hidden');
            document.getElementById('foodAmount').value = '100';
        }

        function addFood() {
            if(!selected) return alert('ìŒì‹ì„ ì„ íƒí•˜ì„¸ìš”!');
            const amt = +document.getElementById('foodAmount').value;
            if(!amt) return alert('ì–‘ì„ ì…ë ¥í•˜ì„¸ìš”!');
            const r = amt/100;
            mealData[currentMeal].push({
                name:selected.name,
                amount:amt,
                cal:Math.round(selected.cal*r),
                pro:Math.round(selected.pro*r*10)/10,
                carb:Math.round(selected.carb*r*10)/10,
                fat:Math.round(selected.fat*r*10)/10
            });
            addToRecent(selected.name);
            selected = null;
            document.getElementById('foodAmount').value = '';
            document.getElementById('amountSection').classList.add('hidden');
            updateAdded();
            backToMethod();
        }

        function addManual() {
            const name = document.getElementById('manualName').value;
            const amt = +document.getElementById('manualAmount').value;
            const cal = +document.getElementById('manualCal').value;
            const pro = +document.getElementById('manualPro').value;
            const carb = +document.getElementById('manualCarb').value;
            const fat = +document.getElementById('manualFat').value;
            
            if(!name||!amt||cal===undefined||pro===undefined||carb===undefined||fat===undefined) {
                return alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”!');
            }

            if(document.getElementById('saveCustom').checked) {
                const r = 100/amt;
                customDB.push({
                    name,
                    cal:Math.round(cal*r),
                    pro:Math.round(pro*r*10)/10,
                    carb:Math.round(carb*r*10)/10,
                    fat:Math.round(fat*r*10)/10,
                    photo: manualPhotoData
                });
                localStorage.setItem('customFoods',JSON.stringify(customDB));
            }

            mealData[currentMeal].push({name,amount:amt,cal:Math.round(cal),pro:Math.round(pro*10)/10,carb:Math.round(carb*10)/10,fat:Math.round(fat*10)/10});
            
            document.getElementById('manualName').value = '';
            document.getElementById('manualAmount').value = '';
            document.getElementById('manualCal').value = '';
            document.getElementById('manualPro').value = '';
            document.getElementById('manualCarb').value = '';
            document.getElementById('manualFat').value = '';
            document.getElementById('saveCustom').checked = false;
            document.getElementById('manualPhoto').value = '';
            document.getElementById('manualPhotoPreview').innerHTML = '';
            manualPhotoData = null;

            updateAdded();
            backToMethod();
        }

        function updateAdded() {
            const foods = mealData[currentMeal];
            const pics = photos[currentMeal];
            
            // ì„ì‹œ ì €ì¥
            saveTempData();
            
            if(foods.length===0 && pics.length===0) {
                document.getElementById('addedSection').classList.add('hidden');
                return;
            }

            document.getElementById('addedSection').classList.remove('hidden');
            let html = '';
            
            if(pics.length>0) {
                html += '<div style="margin-bottom:15px;"><strong>ì‚¬ì§„</strong><div class="photo-grid">';
                pics.forEach(p=>html+=`<img src="${p}" class="photo-item">`);
                html += '</div></div>';
            }

            if(foods.length>0) {
                html += '<div><strong>ìŒì‹</strong>';
                foods.forEach((f,i)=>html+=`
                    <div class="added-item">
                        <div>
                            <div style="font-weight:700;">${f.name} (${f.amount}g)</div>
                            <div style="font-size:0.85rem;opacity:0.8;">${f.cal}kcal | P:${f.pro}g C:${f.carb}g F:${f.fat}g</div>
                        </div>
                        <button onclick="removeFood(${i})" style="background:#ff6b6b;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">ì‚­ì œ</button>
                    </div>
                `);
                html += '</div>';
            }

            document.getElementById('addedList').innerHTML = html;
        }

        function removeFood(i) {
            mealData[currentMeal].splice(i,1);
            updateAdded();
        }

        function addPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        photos[currentMeal].push(ev.target.result);
                        updateAdded();
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function saveMeal() {
            updateCounts();
            updateTotals();
            updatePhotos();
            closeModal();
        }

        function updateCounts() {
            document.getElementById('breakfastCount').textContent = `(${mealData.breakfast.length})`;
            document.getElementById('lunchCount').textContent = `(${mealData.lunch.length})`;
            document.getElementById('dinnerCount').textContent = `(${mealData.dinner.length})`;
            document.getElementById('snackCount').textContent = `(${mealData.snack.length})`;
        }

        function updateTotals() {
            let cal=0,pro=0,carb=0,fat=0;
            Object.values(mealData).forEach(m=>m.forEach(f=>{
                cal+=f.cal;
                pro+=f.pro;
                carb+=f.carb;
                fat+=f.fat;
            }));
            document.getElementById('totalCal').textContent = cal;
            document.getElementById('totalPro').textContent = Math.round(pro*10)/10+'g';
            document.getElementById('totalCarb').textContent = Math.round(carb*10)/10+'g';
            
            updateProgress();
        }

        function updatePhotos() {
            const all = [...photos.breakfast,...photos.lunch,...photos.dinner,...photos.snack];
            if(all.length>0) {
                document.getElementById('photoSection').classList.remove('hidden');
                document.getElementById('photoGrid').innerHTML = all.map(p=>`<img src="${p}" class="photo-item">`).join('');
            } else {
                document.getElementById('photoSection').classList.add('hidden');
            }
        }

        function saveRecord() {
            const w = document.getElementById('todayWeight').value;
            const bf = document.getElementById('todayBodyFat').value;
            if(!w) return alert('ì²´ì¤‘ì„ ì…ë ¥í•˜ì„¸ìš”!');

            let cal=0,pro=0,carb=0,fat=0;
            Object.values(mealData).forEach(m=>m.forEach(f=>{
                cal+=f.cal;
                pro+=f.pro;
                carb+=f.carb;
                fat+=f.fat;
            }));

            const rec = {
                date: new Date().toISOString(),
                weight: +w,
                bodyFat: bf ? +bf : null,
                water: dailyWater,
                meals: JSON.parse(JSON.stringify(mealData)),
                photos: JSON.parse(JSON.stringify(photos)),
                cal, pro: Math.round(pro*10)/10, carb: Math.round(carb*10)/10, fat: Math.round(fat*10)/10,
                exercise: document.getElementById('exercise').checked,
                memo: document.getElementById('memo').value
            };

            let recs = JSON.parse(localStorage.getItem('records')||'[]');
            recs.unshift(rec);
            localStorage.setItem('records',JSON.stringify(recs));

            document.getElementById('todayWeight').value = '';
            document.getElementById('todayBodyFat').value = '';
            document.getElementById('todayBodyFat').disabled = false;
            document.getElementById('todayBodyFat').style.background = '#FAFAFA';
            document.getElementById('bodyFatUnknown').checked = false;
            document.getElementById('exercise').checked = false;
            document.getElementById('memo').value = '';
            dailyWater = 0;
            mealData = {breakfast:[],lunch:[],dinner:[],snack:[]};
            photos = {breakfast:[],lunch:[],dinner:[],snack:[]};
            
            // ì„ì‹œ ë°ì´í„° ì‚­ì œ
            clearTempData();
            
            updateCounts();
            updateTotals();
            updatePhotos();
            loadHistory();
            alert('ê¸°ë¡ ì™„ë£Œ! ğŸ’ª');
        }

        function loadHistory() {
            const recs = JSON.parse(localStorage.getItem('records')||'[]');
            if(recs.length===0) {
                document.getElementById('historyList').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            document.getElementById('historyList').innerHTML = recs.map(r=>{
                const d = new Date(r.date);
                const ds = d.toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric',weekday:'short'});
                let html = `<div class="history-item"><div class="history-date">${ds}</div>`;
                
                if(r.photos) {
                    const allP = [...(r.photos.breakfast||[]),...(r.photos.lunch||[]),...(r.photos.dinner||[]),...(r.photos.snack||[])];
                    if(allP.length>0) {
                        html += '<div class="photo-grid" style="margin:10px 0;">';
                        allP.forEach(p=>html+=`<img src="${p}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;">`);
                        html += '</div>';
                    }
                }
                
                html += `<div class="history-grid">
                    <div>ì²´ì¤‘: <strong>${r.weight}kg</strong></div>
                    ${r.bodyFat ? `<div>ì²´ì§€ë°©: <strong>${r.bodyFat}%</strong></div>` : ''}
                    ${r.water ? `<div>ë¬¼: <strong>${r.water}ml</strong></div>` : ''}
                    <div>ì¹¼ë¡œë¦¬: <strong>${r.cal}kcal</strong></div>
                    <div>ë‹¨ë°±ì§ˆ: <strong>${r.pro}g</strong></div>
                    <div>íƒ„ìˆ˜í™”ë¬¼: <strong>${r.carb}g</strong></div>
                    <div>ì§€ë°©: <strong>${r.fat||0}g</strong></div>
                    <div>ìš´ë™: <strong>${r.exercise?'âœ…':'âŒ'}</strong></div>
                </div>`;
                
                if(r.memo) html += `<div style="margin-top:10px;padding-top:10px;border-top:1px solid #e0e0e0;font-size:0.9rem;color:#666;">${r.memo}</div>`;
                html += '</div>';
                return html;
            }).join('');
        }

        function clearAll() {
            if(confirm('ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('records');
                loadHistory();
            }
        }

        let weeklyChart = null;
        let monthlyChart = null;

        function showTab(tab) {
            document.getElementById('dailyTab').classList.toggle('hidden', tab !== 'daily');
            document.getElementById('weeklyTab').classList.toggle('hidden', tab !== 'weekly');
            document.getElementById('monthlyTab').classList.toggle('hidden', tab !== 'monthly');
            
            document.getElementById('tabDaily').style.background = tab === 'daily' ? 'var(--accent)' : '#e0e0e0';
            document.getElementById('tabDaily').style.color = tab === 'daily' ? 'white' : 'var(--primary)';
            document.getElementById('tabWeekly').style.background = tab === 'weekly' ? 'var(--accent)' : '#e0e0e0';
            document.getElementById('tabWeekly').style.color = tab === 'weekly' ? 'white' : 'var(--primary)';
            document.getElementById('tabMonthly').style.background = tab === 'monthly' ? 'var(--accent)' : '#e0e0e0';
            document.getElementById('tabMonthly').style.color = tab === 'monthly' ? 'white' : 'var(--primary)';

            if(tab === 'weekly') showWeeklyStats();
            if(tab === 'monthly') showMonthlyStats();
        }

        function showWeeklyStats() {
            const recs = JSON.parse(localStorage.getItem('records')||'[]');
            if(recs.length === 0) {
                document.getElementById('weeklyStats').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            // ìµœê·¼ 7ì¼ ë°ì´í„°
            const last7 = recs.slice(0, 7).reverse();
            const dates = last7.map(r => new Date(r.date).toLocaleDateString('ko-KR', {month:'short',day:'numeric'}));
            const weights = last7.map(r => r.weight);
            const bodyFats = last7.map(r => r.bodyFat || null);
            const cals = last7.map(r => r.cal);

            if(weeklyChart) weeklyChart.destroy();

            const ctx = document.getElementById('weeklyChart').getContext('2d');
            weeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'ì²´ì¤‘ (kg)',
                        data: weights,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255,107,107,0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'ì²´ì§€ë°©ë¥  (%)',
                        data: bodyFats,
                        borderColor: '#f7b731',
                        backgroundColor: 'rgba(247,183,49,0.1)',
                        tension: 0.4,
                        yAxisID: 'y1',
                        spanGaps: true
                    }, {
                        label: 'ì¹¼ë¡œë¦¬ (kcal)',
                        data: cals,
                        borderColor: '#4ecdc4',
                        backgroundColor: 'rgba(78,205,196,0.1)',
                        tension: 0.4,
                        yAxisID: 'y2'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'ì²´ì¤‘ (kg)' }},
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'ì²´ì§€ë°©ë¥  (%)' }, grid: { drawOnChartArea: false }},
                        y2: { type: 'linear', display: false, position: 'right' }
                    }
                }
            });

            // ì£¼ê°„ í†µê³„
            const avgWeight = (weights.reduce((a,b)=>a+b,0)/weights.length).toFixed(1);
            const validBodyFats = bodyFats.filter(bf => bf !== null);
            const avgBodyFat = validBodyFats.length > 0 ? (validBodyFats.reduce((a,b)=>a+b,0)/validBodyFats.length).toFixed(1) : '-';
            const avgCal = Math.round(cals.reduce((a,b)=>a+b,0)/cals.length);
            const weightChange = (weights[weights.length-1] - weights[0]).toFixed(1);
            const exerciseDays = last7.filter(r=>r.exercise).length;

            document.getElementById('weeklyStats').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">í‰ê·  ì²´ì¤‘</div>
                        <div class="stat-value">${avgWeight}kg</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">ì²´ì¤‘ ë³€í™”</div>
                        <div class="stat-value">${weightChange>0?'+':''}${weightChange}kg</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">í‰ê·  ì²´ì§€ë°©</div>
                        <div class="stat-value">${avgBodyFat}${avgBodyFat !== '-' ? '%' : ''}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">í‰ê·  ì¹¼ë¡œë¦¬</div>
                        <div class="stat-value">${avgCal}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">ìš´ë™ ì¼ìˆ˜</div>
                        <div class="stat-value">${exerciseDays}ì¼</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">í‰ê·  ë‹¨ë°±ì§ˆ</div>
                        <div class="stat-value">${(last7.reduce((a,r)=>a+r.pro,0)/last7.length).toFixed(1)}g</div>
                    </div>
                </div>
            `;
        }

        function showMonthlyStats() {
            const recs = JSON.parse(localStorage.getItem('records')||'[]');
            if(recs.length === 0) {
                document.getElementById('monthlyStats').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            // ìµœê·¼ 30ì¼ ë°ì´í„°
            const last30 = recs.slice(0, 30).reverse();
            const dates = last30.map(r => new Date(r.date).toLocaleDateString('ko-KR', {month:'short',day:'numeric'}));
            const weights = last30.map(r => r.weight);
            const bodyFats = last30.map(r => r.bodyFat || null);
            const cals = last30.map(r => r.cal);

            if(monthlyChart) monthlyChart.destroy();

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'ì²´ì¤‘ (kg)',
                        data: weights,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255,107,107,0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'ì²´ì§€ë°©ë¥  (%)',
                        data: bodyFats,
                        borderColor: '#f7b731',
                        backgroundColor: 'rgba(247,183,49,0.1)',
                        tension: 0.4,
                        yAxisID: 'y1',
                        spanGaps: true
                    }, {
                        label: 'ì¹¼ë¡œë¦¬ (kcal)',
                        data: cals,
                        borderColor: '#4ecdc4',
                        backgroundColor: 'rgba(78,205,196,0.1)',
                        tension: 0.4,
                        yAxisID: 'y2'
                    }]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'ì²´ì¤‘ (kg)' }},
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'ì²´ì§€ë°©ë¥  (%)' }, grid: { drawOnChartArea: false }},
                        y2: { type: 'linear', display: false, position: 'right' }
                    }
                }
            });

            // ì›”ê°„ í†µê³„
            const avgWeight = (weights.reduce((a,b)=>a+b,0)/weights.length).toFixed(1);
            const validBodyFats = bodyFats.filter(bf => bf !== null);
            const avgBodyFat = validBodyFats.length > 0 ? (validBodyFats.reduce((a,b)=>a+b,0)/validBodyFats.length).toFixed(1) : '-';
            const avgCal = Math.round(cals.reduce((a,b)=>a+b,0)/cals.length);
            const weightChange = (weights[weights.length-1] - weights[0]).toFixed(1);
            const exerciseDays = last30.filter(r=>r.exercise).length;
            const totalDays = last30.length;

            document.getElementById('monthlyStats').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">í‰ê·  ì²´ì¤‘</div>
                        <div class="stat-value">${avgWeight}kg</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">ì²´ì¤‘ ë³€í™”</div>
                        <div class="stat-value">${weightChange>0?'+':''}${weightChange}kg</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">í‰ê·  ì²´ì§€ë°©</div>
                        <div class="stat-value">${avgBodyFat}${avgBodyFat !== '-' ? '%' : ''}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">í‰ê·  ì¹¼ë¡œë¦¬</div>
                        <div class="stat-value">${avgCal}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">ìš´ë™ ì¼ìˆ˜</div>
                        <div class="stat-value">${exerciseDays}/${totalDays}ì¼</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">í‰ê·  ë‹¨ë°±ì§ˆ</div>
                        <div class="stat-value">${(last30.reduce((a,r)=>a+r.pro,0)/last30.length).toFixed(1)}g</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">ğŸ“ˆ í•œ ë‹¬ ìš”ì•½</h3>
                    <div style="display: grid; gap: 10px; font-size: 0.95rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>ì´ ê¸°ë¡ ì¼ìˆ˜:</span>
                            <strong>${totalDays}ì¼</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ìš´ë™ ë‹¬ì„±ë¥ :</span>
                            <strong>${Math.round(exerciseDays/totalDays*100)}%</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ìµœê³  ì²´ì¤‘:</span>
                            <strong>${Math.max(...weights)}kg</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ìµœì € ì²´ì¤‘:</span>
                            <strong>${Math.min(...weights)}kg</strong>
                        </div>
                        ${validBodyFats.length > 0 ? `
                        <div style="display: flex; justify-content: space-between;">
                            <span>ì²´ì§€ë°© ë³€í™”:</span>
                            <strong>${(validBodyFats[validBodyFats.length-1] - validBodyFats[0]).toFixed(1)}%</strong>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        init();
    </script>
    <script>
        // PWA Service Worker ë“±ë¡
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(err => console.log('SW registration failed'));
            });
        }

        // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ì„¤ì¹˜ ì•ˆë‚´ í‘œì‹œ
            const installBanner = document.createElement('div');
            installBanner.innerHTML = `
                <div style="position: fixed; bottom: 20px; left: 20px; right: 20px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 9999; text-align: center;">
                    <p style="margin-bottom: 15px; font-weight: 700; color: var(--primary);">ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ì‹œê² ì–´ìš”?</p>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="installPWA()" style="flex: 1; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;">ì„¤ì¹˜í•˜ê¸°</button>
                        <button onclick="closeBanner()" style="flex: 1; padding: 12px; background: #e0e0e0; color: var(--primary); border: none; border-radius: 10px; font-weight: 700; cursor: pointer;">ë‚˜ì¤‘ì—</button>
                    </div>
                </div>
            `;
            installBanner.id = 'installBanner';
            document.body.appendChild(installBanner);
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    deferredPrompt = null;
                    closeBanner();
                });
            }
        }

        function closeBanner() {
            const banner = document.getElementById('installBanner');
            if (banner) banner.remove();
        }

        // === ë¬¼ ì„­ì·¨ëŸ‰ ê¸°ëŠ¥ ===
        function openWaterModal() { document.getElementById('waterModal').style.display = 'block'; updateWaterDisplay(); }
        function closeWaterModal() { document.getElementById('waterModal').style.display = 'none'; }
        function addWater(amount) { dailyWater += amount; updateWaterDisplay(); }
        function resetWater() { dailyWater = 0; updateWaterDisplay(); }
        function updateWaterDisplay() { document.getElementById('waterDisplay').textContent = dailyWater + 'ml'; }

        // === ì¦ê²¨ì°¾ê¸° ê¸°ëŠ¥ ===
        function openFavoritesModal() { document.getElementById('favoritesModal').style.display = 'block'; renderFavorites(); }
        function closeFavoritesModal() { document.getElementById('favoritesModal').style.display = 'none'; }
        function toggleFavorite(foodName) { const idx = favorites.indexOf(foodName); if(idx > -1) favorites.splice(idx, 1); else favorites.push(foodName); localStorage.setItem('favorites', JSON.stringify(favorites)); }
        function renderFavorites() { const all = [...foodDB, ...customDB]; const favFoods = all.filter(f => favorites.includes(f.name)); if(favFoods.length === 0) { document.getElementById('favoritesList').classList.add('hidden'); document.getElementById('noFavorites').classList.remove('hidden'); return; } document.getElementById('favoritesList').classList.remove('hidden'); document.getElementById('noFavorites').classList.add('hidden'); document.getElementById('favoritesList').innerHTML = favFoods.map(f=>`<div class="food-item" style="display: flex; justify-content: space-between;"><div style="flex: 1;"><div class="food-name">${f.name}</div><div class="food-info">${f.cal}kcal | P:${f.pro}g C:${f.carb}g F:${f.fat}g</div></div><button onclick="toggleFavorite('${f.name}'); renderFavorites();" style="background: none; border: none; font-size: 1.5rem;">â­</button></div>`).join(''); }

        // === ë°±ì—…/ë³µì› ê¸°ëŠ¥ ===
        function openBackupModal() { document.getElementById('backupModal').style.display = 'block'; }
        function closeBackupModal() { document.getElementById('backupModal').style.display = 'none'; }
        function backupData() { const data = { settings: localStorage.getItem('settings'), records: localStorage.getItem('records'), customFoods: localStorage.getItem('customFoods'), favorites: localStorage.getItem('favorites'), goals: localStorage.getItem('goals'), backupDate: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `fit-tracker-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); alert('ë°±ì—… ì™„ë£Œ! ğŸ’¾'); }
        function restoreData() { const file = document.getElementById('restoreFile').files[0]; if(!file) return; const reader = new FileReader(); reader.onload = e => { try { const data = JSON.parse(e.target.result); if(confirm('ê¸°ì¡´ ë°ì´í„°ë¥¼ ë®ì–´ì”ë‹ˆë‹¤. ê³„ì†?')) { if(data.settings) localStorage.setItem('settings', data.settings); if(data.records) localStorage.setItem('records', data.records); if(data.customFoods) localStorage.setItem('customFoods', data.customFoods); if(data.favorites) localStorage.setItem('favorites', data.favorites); if(data.goals) localStorage.setItem('goals', data.goals); alert('ë³µì› ì™„ë£Œ! ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.'); location.reload(); } } catch{ alert('ì˜ëª»ëœ íŒŒì¼ì…ë‹ˆë‹¤.'); } }; reader.readAsText(file); }

        // === ë‹¤í¬ëª¨ë“œ ê¸°ëŠ¥ ===
        // === ì„ì‹œ ì €ì¥ ê¸°ëŠ¥ ===
        function saveTempData() {
            const today = new Date().toDateString();
            const tempData = {
                date: today,
                mealData: mealData,
                photos: photos,
                water: dailyWater
            };
            localStorage.setItem('tempTodayData', JSON.stringify(tempData));
        }

        function loadTempData() {
            const temp = JSON.parse(localStorage.getItem('tempTodayData')||'null');
            if(!temp) return;
            
            const today = new Date().toDateString();
            if(temp.date === today) {
                mealData = temp.mealData || {breakfast:[],lunch:[],dinner:[],snack:[]};
                photos = temp.photos || {breakfast:[],lunch:[],dinner:[],snack:[]};
                dailyWater = temp.water || 0;
                updateCounts();
                updateTotals();
                updatePhotos();
            }
        }

        function clearTempData() {
            localStorage.removeItem('tempTodayData');
        }

        function toggleDarkMode() { isDarkMode = !isDarkMode; localStorage.setItem('darkMode', isDarkMode); isDarkMode ? applyDarkMode() : removeDarkMode(); }
        function applyDarkMode() { document.body.style.background = 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)'; document.querySelectorAll('.card').forEach(c => { c.style.background = '#34495e'; c.style.color = '#ecf0f1'; }); document.querySelectorAll('h2, label').forEach(e => e.style.color = '#ecf0f1'); document.querySelectorAll('input, select, textarea').forEach(i => { i.style.background = '#2c3e50'; i.style.color = '#ecf0f1'; i.style.borderColor = '#7f8c8d'; }); document.getElementById('darkModeBtn').textContent = 'â˜€ï¸ ë¼ì´íŠ¸'; }
        function removeDarkMode() { document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'; document.querySelectorAll('.card').forEach(c => { c.style.background = '#ffffff'; c.style.color = '#1a1a2e'; }); document.querySelectorAll('h2, label').forEach(e => e.style.color = '#1a1a2e'); document.querySelectorAll('input, select, textarea').forEach(i => { i.style.background = '#ffffff'; i.style.color = '#000000'; i.style.borderColor = '#e0e0e0'; }); document.getElementById('darkModeBtn').textContent = 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ'; }

        // === ì‹ë‹¨ í…œí”Œë¦¿ ê¸°ëŠ¥ ===
        function openTemplateModal() { document.getElementById('templateModal').style.display = 'block'; renderTemplates(); }
        function closeTemplateModal() { document.getElementById('templateModal').style.display = 'none'; }
        function saveCurrentAsTemplate() {
            const name = prompt('í…œí”Œë¦¿ ì´ë¦„:');
            if(!name) return;
            const template = { name, foods: JSON.parse(JSON.stringify(mealData[currentMeal])) };
            templates.push(template);
            localStorage.setItem('mealTemplates', JSON.stringify(templates));
            alert('í…œí”Œë¦¿ ì €ì¥ ì™„ë£Œ!');
            renderTemplates();
        }
        function renderTemplates() {
            if(templates.length === 0) {
                document.getElementById('templateList').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            document.getElementById('templateList').innerHTML = templates.map((t,i)=>`
                <div class="food-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <div onclick="applyTemplate(${i})" style="flex: 1; cursor: pointer;">
                        <div class="food-name">${t.name}</div>
                        <div class="food-info">${t.foods.length}ê°œ ìŒì‹</div>
                    </div>
                    <button onclick="deleteTemplate(${i})" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">ì‚­ì œ</button>
                </div>
            `).join('');
        }
        function applyTemplate(idx) {
            mealData[currentMeal] = JSON.parse(JSON.stringify(templates[idx].foods));
            updateAdded();
            updateCounts();
            updateTotals();
            closeTemplateModal();
            alert('í…œí”Œë¦¿ ì ìš© ì™„ë£Œ!');
        }
        function deleteTemplate(idx) {
            if(confirm('í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                templates.splice(idx, 1);
                localStorage.setItem('mealTemplates', JSON.stringify(templates));
                renderTemplates();
            }
        }

        // === ìµœê·¼ ë¨¹ì€ ìŒì‹ ê¸°ëŠ¥ ===
        function openRecentModal() { document.getElementById('recentModal').style.display = 'block'; renderRecent(); }
        function closeRecentModal() { document.getElementById('recentModal').style.display = 'none'; }
        function addToRecent(foodName) {
            recentFoods = recentFoods.filter(f => f !== foodName);
            recentFoods.unshift(foodName);
            if(recentFoods.length > 20) recentFoods = recentFoods.slice(0, 20);
            localStorage.setItem('recentFoods', JSON.stringify(recentFoods));
        }
        function renderRecent() {
            const all = [...foodDB, ...customDB];
            const recent = recentFoods.map(name => all.find(f => f.name === name)).filter(f => f);
            if(recent.length === 0) {
                document.getElementById('recentList').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">ìµœê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            document.getElementById('recentList').innerHTML = recent.map(f=>`
                <div class="food-item" onclick="quickAddFood('${f.name}')">
                    ${f.photo ? `<img src="${f.photo}" class="food-item-photo">` : ''}
                    <div class="food-item-content">
                        <div class="food-name">${f.name}</div>
                        <div class="food-info">${f.cal}kcal | P:${f.pro}g C:${f.carb}g F:${f.fat}g</div>
                    </div>
                </div>
            `).join('');
        }
        function quickAddFood(name) {
            const all = [...foodDB, ...customDB];
            const food = all.find(f => f.name === name);
            if(!food) return;
            const amt = 100;
            const r = amt/100;
            mealData[currentMeal].push({
                name: food.name,
                amount: amt,
                cal: Math.round(food.cal*r),
                pro: Math.round(food.pro*r*10)/10,
                carb: Math.round(food.carb*r*10)/10,
                fat: Math.round(food.fat*r*10)/10
            });
            addToRecent(name);
            updateAdded();
            updateCounts();
            updateTotals();
            closeRecentModal();
        }

        // === ì˜ì–‘ì†Œ ì°¨íŠ¸ ê¸°ëŠ¥ ===
        function openNutritionChartModal() {
            document.getElementById('nutritionChartModal').style.display = 'block';
            renderNutritionChart();
        }
        function closeNutritionChartModal() {
            document.getElementById('nutritionChartModal').style.display = 'none';
        }
        function renderNutritionChart() {
            let cal=0,pro=0,carb=0,fat=0;
            Object.values(mealData).forEach(m=>m.forEach(f=>{
                cal+=f.cal;
                pro+=f.pro;
                carb+=f.carb;
                fat+=f.fat;
            }));
            
            const goals = JSON.parse(localStorage.getItem('goals')||'{}');
            
            if(nutritionChart) nutritionChart.destroy();
            
            const ctx = document.getElementById('nutritionChart').getContext('2d');
            nutritionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ë‹¨ë°±ì§ˆ', 'íƒ„ìˆ˜í™”ë¬¼', 'ì§€ë°©'],
                    datasets: [{
                        data: [pro*4, carb*4, fat*9],
                        backgroundColor: ['#667eea', '#f093fb', '#4ecdc4']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
            
            document.getElementById('nutritionDetails').innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-weight: 700; margin-bottom: 5px;">ë‹¨ë°±ì§ˆ</div>
                        <div>${pro.toFixed(1)}g / ${goals.pro || '-'}g (${goals.pro ? Math.round(pro/goals.pro*100) : 0}%)</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-weight: 700; margin-bottom: 5px;">íƒ„ìˆ˜í™”ë¬¼</div>
                        <div>${carb.toFixed(1)}g / ${goals.carb || '-'}g (${goals.carb ? Math.round(carb/goals.carb*100) : 0}%)</div>
                    </div>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="font-weight: 700; margin-bottom: 5px;">ì§€ë°©</div>
                        <div>${fat.toFixed(1)}g / ${goals.fat || '-'}g</div>
                    </div>
                </div>
            `;
        }

        // === ì•Œë¦¼ ì„¤ì • ê¸°ëŠ¥ ===
        function openNotificationModal() {
            document.getElementById('notificationModal').style.display = 'block';
            loadNotificationSettings();
        }
        function closeNotificationModal() {
            document.getElementById('notificationModal').style.display = 'none';
        }
        function loadNotificationSettings() {
            const settings = JSON.parse(localStorage.getItem('notifSettings')||'{}');
            document.getElementById('notifBreakfast').checked = settings.breakfast || false;
            document.getElementById('notifLunch').checked = settings.lunch || false;
            document.getElementById('notifDinner').checked = settings.dinner || false;
            document.getElementById('notifWater').checked = settings.water || false;
            document.getElementById('timeBreakfast').value = settings.timeBreakfast || '09:00';
            document.getElementById('timeLunch').value = settings.timeLunch || '13:00';
            document.getElementById('timeDinner').value = settings.timeDinner || '19:00';
        }
        function saveNotificationSettings() {
            if('Notification' in window && Notification.permission !== 'granted') {
                Notification.requestPermission().then(permission => {
                    if(permission === 'granted') saveSettings();
                    else alert('ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
                });
            } else {
                saveSettings();
            }
            
            function saveSettings() {
                const settings = {
                    breakfast: document.getElementById('notifBreakfast').checked,
                    lunch: document.getElementById('notifLunch').checked,
                    dinner: document.getElementById('notifDinner').checked,
                    water: document.getElementById('notifWater').checked,
                    timeBreakfast: document.getElementById('timeBreakfast').value,
                    timeLunch: document.getElementById('timeLunch').value,
                    timeDinner: document.getElementById('timeDinner').value
                };
                localStorage.setItem('notifSettings', JSON.stringify(settings));
                alert('ì•Œë¦¼ ì„¤ì • ì €ì¥ ì™„ë£Œ!');
                closeNotificationModal();
                setupNotifications();
            }
        }
        function setupNotifications() {
            const settings = JSON.parse(localStorage.getItem('notifSettings')||'{}');
            // ê°„ë‹¨í•œ ì•Œë¦¼ ì²´í¬ (ì‹¤ì œ êµ¬í˜„ì€ Service Worker í•„ìš”)
            if(settings.breakfast || settings.lunch || settings.dinner) {
                console.log('ì•Œë¦¼ ì„¤ì •ë¨:', settings);
            }
        }

        // === ì¹˜íŒ…ë°ì´ ì•Œë¦¼ ê¸°ëŠ¥ ===
        function checkCheatDayAlert() {
            const recs = JSON.parse(localStorage.getItem('records')||'[]');
            const goals = JSON.parse(localStorage.getItem('goals')||'{}');
            if(recs.length < 7 || !goals.cal) return;
            
            const last7 = recs.slice(0, 7);
            const deficitDays = last7.filter(r => r.cal < goals.cal).length;
            
            if(deficitDays >= 7) {
                const cheatMsg = document.createElement('div');
                cheatMsg.innerHTML = `
                    <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 9999; max-width: 500px; width: 90%;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">ğŸ• ì¹˜íŒ…ë°ì´ ì¶”ì²œ!</div>
                        
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left;">
                            <div style="font-weight: 700; margin-bottom: 10px;">âš ï¸ ì •ì²´ê¸° ë°©ì§€ í•„ìš”</div>
                            <div style="font-size: 0.9rem;">7ì¼ ì—°ì† ì¹¼ë¡œë¦¬ ë¶€ì¡± ìƒíƒœì…ë‹ˆë‹¤.<br>ë‚´ì¼ì€ ìœ ì§€ì¹¼ë¡œë¦¬ë¡œ ì‹ì‚¬í•˜ì„¸ìš”!</div>
                        </div>

                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left;">
                            <div style="font-weight: 700; margin-bottom: 10px;">ğŸš íƒ„ìˆ˜í™”ë¬¼ ìœ„ì£¼ë¡œ!</div>
                            <div style="font-size: 0.9rem; line-height: 1.6;">
                                â€¢ ëª©í‘œ ì¹¼ë¡œë¦¬: <strong>${Math.round(goals.cal + 500)}kcal</strong><br>
                                â€¢ íƒ„ìˆ˜í™”ë¬¼ì„ í‰ì†Œë³´ë‹¤ ë§ì´ (íŒŒìŠ¤íƒ€, í”¼ì, ë¹µ, ê³¼ì¼)<br>
                                â€¢ ë‹¨ë°±ì§ˆ/ì§€ë°©ì€ í‰ì†ŒëŒ€ë¡œ ìœ ì§€<br>
                                â€¢ ì´ìœ : ê¸€ë¦¬ì½”ê² ì¬ì¶©ì „ìœ¼ë¡œ ëŒ€ì‚¬ íšŒë³µ ğŸ’ª
                            </div>
                        </div>

                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left;">
                            <div style="font-weight: 700; margin-bottom: 8px;">ğŸ ì¶”ì²œ ìŒì‹</div>
                            <div style="font-size: 0.85rem; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                                <div>â€¢ í”¼ì</div>
                                <div>â€¢ íŒŒìŠ¤íƒ€</div>
                                <div>â€¢ ë¹µë¥˜</div>
                                <div>â€¢ ê³¼ì¼</div>
                                <div>â€¢ ê³ êµ¬ë§ˆ</div>
                                <div>â€¢ êµ­ìˆ˜</div>
                                <div>â€¢ ì´ˆë°¥</div>
                            </div>
                        </div>

                        <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; background: white; color: #f5576c; border: none; padding: 12px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                            í™•ì¸í–ˆì–´ìš”!
                        </button>
                    </div>
                `;
                document.body.appendChild(cheatMsg);
            }
        }
    </script>
</body>
</html>